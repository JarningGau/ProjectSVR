<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Project the perturbed germ cells onto mouse testicular cell atlas • ProjectSVR</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Project the perturbed germ cells onto mouse testicular cell atlas"><meta property="og:description" content="ProjectSVR"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-W1XR84YEPZ"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-W1XR84YEPZ');
</script></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ProjectSVR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/quick_start.html">Quick start</a>
    </li>
    <li>
      <a href="../articles/ICB_breast_cancer.html">Pan-cancer T cell landscape</a>
    </li>
    <li>
      <a href="../articles/mTCA_perturbed_germ_cells.html">Mouse testicular cell atlas</a>
    </li>
  </ul></li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/JarningGau/ProjectSVR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>





<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Project the perturbed germ cells onto mouse testicular cell atlas</h1>
            
            <h4 data-toc-skip class="date">Compiled: July 24, 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JarningGau/ProjectSVR/blob/HEAD/vignettes/mTCA_perturbed_germ_cells.Rmd" class="external-link"><code>vignettes/mTCA_perturbed_germ_cells.Rmd</code></a></small>
      <div class="hidden name"><code>mTCA_perturbed_germ_cells.Rmd</code></div>

    </div>

    
    
<p>To illustrate ProjectSVR’s ability to enable the interpretation of defects of perturbed stages in a continuous developmental trajectory. Here, we provide a tutorial about how to project Zfp541-KO and WT germ cells <a href="#refer-anchor-1"><sup>1</sup></a> onto a mouse testicular cell atlas.</p>
<p>In this tutorial, we do not utilize the advanced wrapper functions (<code>MapQuery</code> and <code>LabelTransfer</code>) to illustrate how to use the functions underly.</p>
<p>We adopt consensus non-negative matrix factorization (cNMF) for feature extraction instead of the <code>FindAllMarkers</code> function in Seurat when we didn’t know the suitable granularity for cell clusters.</p>
<div id="download-related-dataset" class="section level2">
<h2>Download Related Dataset</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ProjectSVR)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">requireNamespace</span>(<span class="st">&quot;sceasy&quot;</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;cellgeni/sceasy&quot;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">timeout =</span> <span class="fu">max</span>(<span class="dv">3600</span>, <span class="fu">getOption</span>(<span class="st">&quot;timeout&quot;</span>)))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>OUTPATH <span class="ot">=</span> <span class="st">&quot;perturbed_gc&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(OUTPATH)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reference data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We provide reference in qs format for quicklyu saving and readling objects to and from disk.</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># https://cran.r-project.org/web/packages/qs/vignettes/vignette.html</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="at">url =</span> <span class="st">&quot;&quot;</span>, <span class="at">destfile =</span> <span class="st">&quot;mTCA.seurat.slim.qs&quot;</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># query data</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="at">url =</span> <span class="st">&quot;&quot;</span>, <span class="at">destfile =</span> <span class="st">&quot;query_Zfp541-KO.seurat.slim.qs&quot;</span>)</span></code></pre></div>
</div>
<div id="feature-selection" class="section level2">
<h2>Feature Selection</h2>
<div id="load-reference-data" class="section level3">
<h3>Load reference data</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>seu.ref <span class="ot">&lt;-</span> qs<span class="sc">::</span><span class="fu">qread</span>(<span class="st">&quot;mTCA.seurat.slim.qs&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>data.plot <span class="ot">&lt;-</span> <span class="fu">FetchData</span>(seu.ref, <span class="at">vars =</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;UMAP_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>), <span class="st">&quot;Cell_type_symbol&quot;</span>) )</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.plot, <span class="fu">aes</span>(UMAP_1, UMAP_2, <span class="at">color =</span> Cell_type_symbol), <span class="at">pt.size =</span> .<span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> .<span class="dv">1</span>, <span class="at">alpha =</span> .<span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> seu.ref<span class="sc">@</span>misc<span class="sc">$</span>data.refplot<span class="sc">$</span>colors) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">inherit.aes =</span> F, <span class="at">data =</span> seu.ref<span class="sc">@</span>misc<span class="sc">$</span>data.refplot<span class="sc">$</span>text.pos,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">mapping =</span> <span class="fu">aes</span>(x, y, <span class="at">label =</span> label), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">DimTheme</span>()</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/referenc_plot-1.png" width="1056" /></p>
</div>
<div id="make-meta-cells" class="section level3">
<h3>Make meta cells</h3>
<p>Here, we introduce the consensus NMF (cNMF) methods for signature extraction.</p>
<p>To speed up the cNMF procedure, we utilize the meta cell method that merges the adjacent cells in UMAP space into meta cells.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Grid the adjacent cells in the UMAP space.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>emb.mat <span class="ot">&lt;-</span> seu.ref[[<span class="st">&quot;umap&quot;</span>]]<span class="sc">@</span>cell.embeddings</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>gd <span class="ot">&lt;-</span> <span class="fu">EstimateKnnDensity</span>(<span class="at">emb.mat =</span> emb.mat)</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/meta_cells-1.png" width="768" /></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>gd <span class="ot">&lt;-</span> <span class="fu">subset</span>(gd, <span class="at">bin.density.threshold=</span><span class="fl">1e-4</span>, <span class="at">n.cells.threshold=</span><span class="dv">10</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gd)</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/meta_cells-2.png" width="768" /></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Make meta cells</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>metacell.counts <span class="ot">&lt;-</span> <span class="fu">MergeCells</span>(seu.ref[[<span class="st">&quot;RNA&quot;</span>]]<span class="sc">@</span>data, <span class="at">gd =</span> gd, <span class="at">by =</span> <span class="st">&quot;mesh.points&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(metacell.counts)</span></code></pre></div>
<pre><code>## [1] 32285  3934</code></pre>
<p>Now we compress the 188,862 cells into 3934 meta cells.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## The genes expressed in at least 20 cells were kept.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>expr.in.cells <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">rowSums</span>(metacell.counts <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>metacell.counts <span class="ot">&lt;-</span> metacell.counts[expr.in.cells <span class="sc">&gt;=</span> <span class="dv">20</span>, ]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Drop mitochondrial genes</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>is.mito <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;^mt-&quot;</span>, <span class="fu">rownames</span>(metacell.counts))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>metacell.counts <span class="ot">&lt;-</span> metacell.counts[<span class="sc">!</span>is.mito, ]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Transfer the Seurat format into h5ad file.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>seu.mc <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(<span class="at">counts =</span> metacell.counts)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>sceasy<span class="sc">::</span><span class="fu">convertFormat</span>(seu.mc, <span class="at">from =</span> <span class="st">&quot;seurat&quot;</span>, <span class="at">to =</span> <span class="st">&quot;anndata&quot;</span>, <span class="at">main_layer =</span> <span class="st">&quot;counts&quot;</span>, </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">outFile =</span> <span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;mTCA.metacells.h5ad&quot;</span>))</span></code></pre></div>
<pre><code>## AnnData object with n_obs × n_vars = 3934 × 28549
##     obs: &#39;orig.ident&#39;, &#39;nCount_RNA&#39;, &#39;nFeature_RNA&#39;
##     var: &#39;name&#39;</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Save HVGs</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(seu.ref[[<span class="st">&quot;RNA&quot;</span>]]<span class="sc">@</span>var.features, <span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;mTCA.metacells.hvgs.txt&quot;</span>))</span></code></pre></div>
</div>
<div id="run-cnmf" class="section level3">
<h3>Run cNMF</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FindOptimalK</span>(<span class="at">counts.fn =</span> <span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;mTCA.metacells.h5ad&quot;</span>),</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">run.name =</span> <span class="st">&quot;K20_K100_by5&quot;</span>, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">components =</span> <span class="fu">seq</span>(<span class="dv">20</span>,<span class="dv">100</span>,<span class="dv">5</span>), </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">genes.fn =</span> <span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;mTCA.metacells.hvgs.txt&quot;</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">out.path =</span> OUTPATH,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">n.iter =</span> <span class="dv">20</span>, </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">cores =</span> <span class="dv">20</span>)</span></code></pre></div>
<p>This will generate a deagnostic plot for the K selection under <code>perturbed_gc/K20_K100_by5/K20_K100_by5.k_selection.png</code>.</p>
<p><img src="../reference/figures/perturbed-gc-cnmf-k-selection.png" /></p>
<p>The solution of K = 70 makes the decomposition the less reconstruction error without the loss of solution robustness.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">RunCNMF</span>(<span class="at">counts.fn =</span> <span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;mTCA.metacells.h5ad&quot;</span>), </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">run.name =</span> <span class="st">&quot;K70&quot;</span>, </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">out.path =</span> OUTPATH, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">70</span>, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">genes.fn =</span> <span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;mTCA.metacells.hvgs.txt&quot;</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">n.iter =</span> <span class="dv">50</span>, <span class="co"># here we run more iterations.</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">cores =</span> <span class="dv">20</span>, </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">local.density.cutoff =</span> <span class="fl">0.2</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">n.top.genes =</span> <span class="dv">100</span>, </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">show.clustering =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="feature-evaluation" class="section level3">
<h3>Feature evaluation</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>top.genes <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;K70/top100_genes.k_70.dt_0_2.txt&quot;</span>), <span class="at">header =</span> T)</span></code></pre></div>
<p>Here, we try the <a href="https://bioconductor.org/packages/release/bioc/html/AUCell.html">AUCell</a> method for calculating signature scores.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> seu.ref[[<span class="st">&quot;RNA&quot;</span>]]<span class="sc">@</span>data</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>auc.mat <span class="ot">&lt;-</span> <span class="fu">ComputeModuleScore</span>(counts, <span class="at">gene.sets =</span> top.genes, <span class="at">method =</span> <span class="st">&quot;AUCell&quot;</span>, <span class="at">cores =</span> <span class="dv">10</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(auc.mat, <span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;mTCA.AUCell.rds&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>auc.mat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(OUTPATH, <span class="st">&quot;mTCA.AUCell.rds&quot;</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>emb.mat <span class="ot">&lt;-</span> seu.ref[[<span class="st">&quot;umap&quot;</span>]]<span class="sc">@</span>cell.embeddings</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>sel.cells <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rownames</span>(auc.mat), <span class="at">size =</span> <span class="fl">1e4</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>data.plot <span class="ot">&lt;-</span> <span class="fu">cbind</span>(auc.mat[sel.cells, ], emb.mat[sel.cells, ])</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>data.plot <span class="ot">&lt;-</span> data.plot <span class="sc">%&gt;%</span> </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">70</span>, <span class="at">names_to =</span> <span class="st">&quot;component&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;score&quot;</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>data.plot <span class="sc">%&gt;%</span> </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_split</span>(component) <span class="sc">%&gt;%</span> </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span><span class="fu">ggplot</span>(., <span class="fu">aes</span>(UMAP_1, UMAP_2, <span class="at">color =</span> score)) <span class="sc">+</span> </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">size =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_grid</span>(<span class="sc">~</span> component, <span class="at">labeller =</span> <span class="cf">function</span>(x) <span class="fu">label_value</span>(x, <span class="at">multi_line =</span> <span class="cn">FALSE</span>)) <span class="sc">+</span> </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> ., <span class="at">align =</span> <span class="st">&#39;hv&#39;</span>, <span class="at">ncol =</span> <span class="dv">7</span>)</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/feature_plot-1.png" width="2688" /></p>
</div>
</div>
<div id="build-reference-model" class="section level2">
<h2>Build Reference Model</h2>
<div id="training-reference-model" class="section level3">
<h3>Training reference model</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>umap.model <span class="ot">&lt;-</span> <span class="fu">FitEnsembleSVM</span>(<span class="at">feature.mat =</span> auc.mat, <span class="at">emb.mat =</span> emb.mat, <span class="at">n.models =</span> <span class="dv">20</span>, <span class="at">cores =</span> <span class="dv">20</span>)</span></code></pre></div>
</div>
<div id="save-the-reference-model" class="section level3">
<h3>Save the reference model</h3>
<p>ref.cellmeta stores:</p>
<ol style="list-style-type: decimal">
<li><p>[optional] colors: for plots</p></li>
<li><p>[optional] text.pos: text annotation on the reference plots</p></li>
<li><p>meta.data: cell meta data (embeddings + cell type information)</p></li>
</ol>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ref.cellmeta <span class="ot">&lt;-</span> seu.ref<span class="sc">@</span>misc<span class="sc">$</span>data.refplot</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>ref.cellmeta<span class="sc">$</span>meta.data <span class="ot">&lt;-</span> <span class="fu">FetchData</span>(seu.ref, <span class="at">vars =</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;UMAP_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>), <span class="st">&quot;Cell_type_symbol&quot;</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>reference <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;models&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;umap&quot;</span> <span class="ot">=</span> umap.model</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;genes&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;gene.sets&quot;</span> <span class="ot">=</span> top.genes <span class="co"># list</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;ref.cellmeta&quot;</span> <span class="ot">=</span> ref.cellmeta <span class="co"># list for reference plot</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(reference, <span class="st">&quot;model.mTCA.rds&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="map-query-to-reference" class="section level2">
<h2>Map Query to Reference</h2>
<div id="reference-mapping" class="section level3">
<h3>Reference mapping</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>reference <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;model.mTCA.rds&quot;</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>seu.q <span class="ot">&lt;-</span> qs<span class="sc">::</span><span class="fu">qread</span>(<span class="st">&quot;query_Zfp541-KO.seurat.slim.qs&quot;</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> <span class="fu">ComputeModuleScore</span>(seu.q[[<span class="st">&quot;RNA&quot;</span>]]<span class="sc">@</span>data, <span class="at">gene.sets =</span> top.genes, </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">method =</span> <span class="st">&quot;AUCell&quot;</span>, <span class="at">cores =</span> <span class="dv">20</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>proj.res <span class="ot">&lt;-</span> <span class="fu">ProjectNewdata</span>(<span class="at">feature.mat =</span> newdata, <span class="at">model =</span> reference<span class="sc">$</span>models<span class="sc">$</span>umap, <span class="at">cores =</span> <span class="dv">20</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>proj.res</span></code></pre></div>
<pre><code>## An object of class CellProject 
## @data:  70 features across 17253 cells.
## @embeddings:  ( 17253 , 2 ).
## @refined.embeddings:  ( 0 , 0 ).
## @cellmeta:  ( 17253 , 0 ).
## @neighbors: NULL</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>seu.q[[<span class="st">&quot;ref.umap&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">CreateDimReducObject</span>(proj.res<span class="sc">@</span>embeddings, <span class="at">key =</span> <span class="st">&quot;refUMAP_&quot;</span>, <span class="at">assay =</span> <span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(seu.q, <span class="at">reduction =</span> <span class="st">&quot;ref.umap&quot;</span>, <span class="at">group.by =</span> <span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(seu.q, <span class="at">reduction =</span> <span class="st">&quot;ref.umap&quot;</span>, <span class="at">group.by =</span> <span class="st">&quot;annotation&quot;</span>, <span class="at">label =</span> T)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">&amp;</span> ggsci<span class="sc">::</span><span class="fu">scale_color_d3</span>(<span class="st">&quot;category20&quot;</span>)</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/reference_mapping-1.png" width="1152" /></p>
</div>
<div id="mapping-quality" class="section level3">
<h3>Mapping quality</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>proj.res <span class="ot">&lt;-</span> <span class="fu">AddProjQual</span>(<span class="at">object =</span> proj.res, <span class="at">k =</span> <span class="dv">20</span>, <span class="at">repeats =</span> <span class="fl">1e4</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(proj.res<span class="sc">@</span>cellmeta)</span></code></pre></div>
<pre><code>##                       mean.knn.dist p.val p.adj
## WT_AAACCCAAGCGATCGA-1     0.5288546     0     0
## WT_AAACCCAAGCTAGAAT-1     0.3845612     0     0
## WT_AAACCCACAACGGTAG-1     0.6126770     0     0
## WT_AAACCCACAATATCCG-1     1.0047275     0     0
## WT_AAACCCACAGGCGATA-1     0.4237840     0     0
## WT_AAACCCACATATGGCT-1     0.5636432     0     0</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>seu.q<span class="sc">$</span>mean.knn.dist <span class="ot">&lt;-</span> proj.res<span class="sc">@</span>cellmeta<span class="sc">$</span>mean.knn.dist</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>seu.q<span class="sc">$</span>mapQ.p.val <span class="ot">&lt;-</span> proj.res<span class="sc">@</span>cellmeta<span class="sc">$</span>p.val</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>seu.q<span class="sc">$</span>mapQ.p.adj <span class="ot">&lt;-</span> proj.res<span class="sc">@</span>cellmeta<span class="sc">$</span>p.adj</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>data.plot <span class="ot">&lt;-</span> <span class="fu">FetchData</span>(seu.q, <span class="at">vars =</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;refUMAP_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>), <span class="st">&quot;mean.knn.dist&quot;</span>, <span class="st">&quot;mapQ.p.adj&quot;</span>))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.plot, <span class="fu">aes</span>(mean.knn.dist, <span class="sc">-</span><span class="fu">log10</span>(mapQ.p.adj))) <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> .<span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">2.4</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/map_qc_threshold-1.png" width="480" /></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">## cutoff by adjusted p value</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">MapQCPlot</span>(seu.q, <span class="at">p.adj.cutoff =</span> <span class="fl">1e-3</span>)</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/map_qc_plot-1.png" width="1344" /></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">## or mean.knn.dist</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">MapQCPlot</span>(seu.q, <span class="at">map.q.cutoff =</span> <span class="fl">2.4</span>)</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/map_qc_plot-2.png" width="1344" /></p>
</div>
<div id="label-transfer" class="section level3">
<h3>Label transfer</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>seu.q <span class="ot">&lt;-</span> <span class="fu">subset</span>(seu.q, mean.knn.dist <span class="sc">&lt;</span> <span class="fl">2.4</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="do">## input for KNN label transfer</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>ref.cellmeta <span class="ot">&lt;-</span> reference<span class="sc">$</span>ref.cellmeta<span class="sc">$</span>meta.data</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>query.emb <span class="ot">&lt;-</span> seu.q[[<span class="st">&quot;ref.umap&quot;</span>]]<span class="sc">@</span>cell.embeddings</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>ref.emb <span class="ot">&lt;-</span> ref.cellmeta[, <span class="fu">paste0</span>(<span class="st">&quot;UMAP_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>ref.labels <span class="ot">&lt;-</span> ref.cellmeta[[<span class="st">&quot;Cell_type_symbol&quot;</span>]]</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ref.labels) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(ref.cellmeta)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="do">## KNN label transfer</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>knn.pred.res <span class="ot">&lt;-</span> <span class="fu">KnnLabelTransfer</span>(<span class="at">query.emb =</span> query.emb, <span class="at">ref.emb =</span> ref.emb, </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">ref.labels =</span> ref.labels, <span class="at">k =</span> <span class="dv">100</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>knn.pred.mv <span class="ot">&lt;-</span> <span class="fu">MajorityVote</span>(<span class="at">feature.mat =</span> newdata, </span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>                            <span class="at">cell.types =</span> knn.pred.res[, <span class="fu">c</span>(<span class="st">&quot;labels&quot;</span>), <span class="at">drop =</span> F], </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>                            <span class="at">k =</span> <span class="dv">100</span>, </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min.prop =</span> <span class="fl">0.3</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="do">## write results into Seurat object.</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>seu.q<span class="sc">$</span>knn.pred.celltype <span class="ot">&lt;-</span> knn.pred.res<span class="sc">$</span>labels</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>seu.q<span class="sc">$</span>knn.pred.celltype.major_votes <span class="ot">&lt;-</span> knn.pred.mv<span class="sc">$</span>labels.major_votes</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>ref.celltype.levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(ref.cellmeta[[<span class="st">&quot;Cell_type_symbol&quot;</span>]])</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>seu.q<span class="sc">$</span>knn.pred.celltype <span class="ot">&lt;-</span> <span class="fu">factor</span>(seu.q<span class="sc">$</span>knn.pred.celltype, <span class="at">levels =</span> ref.celltype.levels)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>seu.q<span class="sc">$</span>knn.pred.celltype.major_votes <span class="ot">&lt;-</span> <span class="fu">factor</span>(seu.q<span class="sc">$</span>knn.pred.celltype.major_votes, </span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">levels =</span> ref.celltype.levels)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(seu.q, <span class="at">reduction =</span> <span class="st">&quot;ref.umap&quot;</span>, <span class="at">group.by =</span> <span class="st">&quot;knn.pred.celltype.major_votes&quot;</span>, </span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">split.by =</span> <span class="st">&quot;orig.ident&quot;</span>) <span class="sc">+</span> </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_d3</span>()</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/label_transfer-1.png" width="672" /></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>data.stat <span class="ot">&lt;-</span> <span class="fu">table</span>(seu.q<span class="sc">$</span>annotation, seu.q<span class="sc">$</span>knn.pred.celltype.major_votes)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>data.stat <span class="ot">&lt;-</span> data.stat[, <span class="fu">colSums</span>(data.stat) <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>pheatmap<span class="sc">::</span><span class="fu">pheatmap</span>(data.stat, <span class="at">display_numbers =</span> T, <span class="at">number_format =</span> <span class="st">&quot;%.0f&quot;</span>, </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">cluster_rows =</span> F, <span class="at">cluster_cols =</span> F,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">number_color =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
<p><img src="mTCA_perturbed_germ_cells_files/figure-html/compare_heatmap-1.png" width="576" /></p>
<details>
<summary>
<strong>Session Info</strong>
</summary>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code></pre></div>
<pre><code>## R version 4.1.2 (2021-11-01)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: CentOS Linux 7 (Core)
## 
## Matrix products: default
## BLAS:   /opt/R4.1/lib64/R/lib/libRblas.so
## LAPACK: /opt/R4.1/lib64/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] forcats_0.5.2         stringr_1.4.1         dplyr_1.0.10         
##  [4] purrr_0.3.4           readr_2.1.2           tidyr_1.2.1          
##  [7] tibble_3.1.8          ggplot2_3.4.1         tidyverse_1.3.2      
## [10] ProjectSVR_0.1.0.9000 sp_1.5-0              SeuratObject_4.1.2   
## [13] Seurat_4.2.0         
## 
## loaded via a namespace (and not attached):
##   [1] rappdirs_0.3.3              scattermore_0.8            
##   [3] R.methodsS3_1.8.2           ragg_1.2.2                 
##   [5] bit64_4.0.5                 knitr_1.40                 
##   [7] DelayedArray_0.20.0         R.utils_2.12.0             
##   [9] irlba_2.3.5                 data.table_1.14.2          
##  [11] rpart_4.1.16                RCurl_1.98-1.8             
##  [13] KEGGREST_1.34.0             doParallel_1.0.17          
##  [15] generics_0.1.3              BiocGenerics_0.40.0        
##  [17] cowplot_1.1.1               RSQLite_2.2.17             
##  [19] RApiSerialize_0.1.2         RANN_2.6.1                 
##  [21] future_1.28.0               bit_4.0.4                  
##  [23] tzdb_0.3.0                  spatstat.data_3.0-0        
##  [25] xml2_1.3.3                  lubridate_1.8.0            
##  [27] httpuv_1.6.6                ggsci_2.9                  
##  [29] SummarizedExperiment_1.24.0 assertthat_0.2.1           
##  [31] gargle_1.2.1                xfun_0.33                  
##  [33] hms_1.1.2                   jquerylib_0.1.4            
##  [35] evaluate_0.16               promises_1.2.0.1           
##  [37] fansi_1.0.3                 dbplyr_2.2.1               
##  [39] readxl_1.4.1                igraph_1.3.5               
##  [41] DBI_1.1.3                   htmlwidgets_1.5.4          
##  [43] spatstat.geom_3.0-3         googledrive_2.0.0          
##  [45] stats4_4.1.2                ellipsis_0.3.2             
##  [47] mlr3data_0.6.1              backports_1.4.1            
##  [49] annotate_1.72.0             MatrixGenerics_1.6.0       
##  [51] RcppParallel_5.1.6          deldir_1.0-6               
##  [53] vctrs_0.5.1                 Biobase_2.54.0             
##  [55] here_1.0.1                  ROCR_1.0-11                
##  [57] abind_1.4-5                 cachem_1.0.6               
##  [59] withr_2.5.0                 mlr3verse_0.2.5            
##  [61] mlr3learners_0.5.4          progressr_0.11.0           
##  [63] checkmate_2.1.0             sctransform_0.3.5          
##  [65] mlr3fselect_0.7.2           goftest_1.2-3              
##  [67] cluster_2.1.4               lazyeval_0.2.2             
##  [69] crayon_1.5.1                pkgconfig_2.0.3            
##  [71] labeling_0.4.2              GenomeInfoDb_1.30.1        
##  [73] nlme_3.1-155                rlang_1.0.6                
##  [75] globals_0.16.1              lifecycle_1.0.3            
##  [77] miniUI_0.1.1.1              palmerpenguins_0.1.1       
##  [79] modelr_0.1.9                cellranger_1.1.0           
##  [81] rprojroot_2.0.3             polyclip_1.10-0            
##  [83] matrixStats_0.62.0          lmtest_0.9-40              
##  [85] graph_1.74.0                Matrix_1.5-1               
##  [87] zoo_1.8-11                  reprex_2.0.2               
##  [89] pheatmap_1.0.12             ggridges_0.5.3             
##  [91] GlobalOptions_0.1.2         googlesheets4_1.0.1        
##  [93] png_0.1-7                   viridisLite_0.4.1          
##  [95] rjson_0.2.21                stringfish_0.15.8          
##  [97] bitops_1.0-7                R.oo_1.25.0                
##  [99] KernSmooth_2.23-20          Biostrings_2.62.0          
## [101] blob_1.2.3                  shape_1.4.6                
## [103] paradox_0.10.0              parallelly_1.32.1          
## [105] spatstat.random_3.0-1       S4Vectors_0.32.4           
## [107] scales_1.2.1                memoise_2.0.1              
## [109] GSEABase_1.56.0             magrittr_2.0.3             
## [111] plyr_1.8.7                  ica_1.0-3                  
## [113] zlibbioc_1.40.0             compiler_4.1.2             
## [115] RColorBrewer_1.1-3          clue_0.3-61                
## [117] fitdistrplus_1.1-8          cli_3.4.1                  
## [119] XVector_0.34.0              mlr3tuningspaces_0.3.0     
## [121] mlr3filters_0.6.0           listenv_0.8.0              
## [123] patchwork_1.1.2             pbapply_1.5-0              
## [125] MASS_7.3-58.1               mgcv_1.8-40                
## [127] tidyselect_1.1.2            stringi_1.7.6              
## [129] textshaping_0.3.6           highr_0.9                  
## [131] yaml_2.3.5                  ggrepel_0.9.1              
## [133] grid_4.1.2                  sass_0.4.2                 
## [135] tools_4.1.2                 mlr3misc_0.11.0            
## [137] future.apply_1.9.1          parallel_4.1.2             
## [139] mlr3cluster_0.1.4           circlize_0.4.15            
## [141] rstudioapi_0.14             uuid_1.1-0                 
## [143] qs_0.25.5                   foreach_1.5.2              
## [145] AUCell_1.16.0               gridExtra_2.3              
## [147] farver_2.1.1                Rtsne_0.16                 
## [149] digest_0.6.29               rgeos_0.5-9                
## [151] shiny_1.7.2                 Rcpp_1.0.9                 
## [153] GenomicRanges_1.46.1        broom_1.0.1                
## [155] later_1.3.0                 RcppAnnoy_0.0.19           
## [157] httr_1.4.4                  AnnotationDbi_1.56.2       
## [159] mlr3tuning_0.14.0           ComplexHeatmap_2.10.0      
## [161] colorspace_2.0-3            rvest_1.0.3                
## [163] XML_3.99-0.9                fs_1.5.2                   
## [165] tensor_1.5                  reticulate_1.26            
## [167] IRanges_2.28.0              splines_4.1.2              
## [169] lgr_0.4.4                   uwot_0.1.14                
## [171] bbotk_0.5.4                 spatstat.utils_3.0-1       
## [173] pkgdown_2.0.6               mlr3pipelines_0.4.2        
## [175] plotly_4.10.0               systemfonts_1.0.4          
## [177] xtable_1.8-4                jsonlite_1.8.0             
## [179] sceasy_0.0.7                R6_2.5.1                   
## [181] clusterCrit_1.2.8           pillar_1.8.1               
## [183] htmltools_0.5.3             mime_0.12                  
## [185] glue_1.6.2                  fastmap_1.1.0              
## [187] mlr3_0.14.0                 codetools_0.2-18           
## [189] utf8_1.2.2                  lattice_0.20-45            
## [191] bslib_0.4.0                 spatstat.sparse_3.0-0      
## [193] curl_5.0.1                  leiden_0.4.3               
## [195] mlr3viz_0.5.10              survival_3.4-0             
## [197] rmarkdown_2.16              desc_1.4.2                 
## [199] munsell_0.5.0               GenomeInfoDbData_1.2.7     
## [201] GetoptLong_1.0.5            iterators_1.0.14           
## [203] haven_2.5.1                 reshape2_1.4.4             
## [205] gtable_0.3.1                spatstat.core_2.4-4</code></pre>
</details>
</div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<div id="refer-anchor-1">

</div>
<ul>
<li>[1] <a href="https://pubmed.ncbi.nlm.nih.gov/35320728/">Xu J, et al. ZFP541 maintains the repression of pre-pachytene transcriptional programs and promotes male meiosis progression. Cell Rep. 2022 Mar 22;38(12):110540. doi: 10.1016/j.celrep.2022.110540. PMID: 35320728.</a></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
      </div>

</div>



      <footer><div class="copyright">
  <p></p><p>Developed by Jianing Gao.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>
